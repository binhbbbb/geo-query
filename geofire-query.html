<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="scripts.html">
<link rel="import" href="geofire-elements-behavior.html">

<!--
`geofire-query`
An element for working with GeoFire's [`GeoQuery`](https://github.com/firebase/geofire-js/blob/master/docs/reference.md#geoquery)s.

@demo demo/index.html
-->

<dom-module id="geofire-query">
  <template>
    <style>
      :host {
        /*display: block;*/
      }
    </style>
  </template>

  <script>
    Polymer({

      is: 'geofire-query',

      properties: {
        /**
         * The latitude for the query's center.
         */
        lat: Number,

        /**
         * The longitude for the query's center.
         */
        lng: Number,

        /**
         * The radius in kilometers around the query's center.
         */
        radius: Number,

        /**
         * Whether the query is active and listening for GeoQuery events.
         */
        enabled: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          observer: '_enabledChanged'
        },

        /**
         * An array managed by the GeoQuery events.
         * Each element is an object with properties `key, lat, lng, location, distance`.
         */
        resultsArray: {
          type: Array,
          notify: true
        },

        /**
         * An object managed by the GeoQuery events.
         * It is a map of key => {`lat, lng, location, distance`}.
         */
        resultsObject: {
          type: Object,
          notify: true
        }
      },

      observers: [
        '_queryChanged(lat, lng, radius)'
      ],

      behaviors: [
          GeofireElementsBehavior
      ],

      /**
       * The [GeoQuery](https://github.com/firebase/geofire-js/blob/master/docs/reference.md#geoquery) instance.
       */
      get query() {
        if (!this.queryInstance) {
          this.queryInstance = this.geofire.query({
            center: [this.lat, this.lng],
            radius: this.radius
          });
        }
        return this.queryInstance;
      },

      _enabledChanged: function(enabled) {
        if (enabled) {
          this.resultsArray = [];
          this.resultsObject = {};


          this.onKeyEnteredRegistration = this.query.on("key_entered", function(key, location, distance) {
            this.resultsObject[key] = {
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            var data = {
              key: key,
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            this.resultsArray.push(data);
            this.fire('key-entered', data);
          }.bind(this));

          this.onKeyExitedRegistration = this.query.on("key_exited", function(key, location, distance) {
            this.resultsObject[key] = null;
            for (var i = 0; i < this.resultsArray.length; i++) {
              if (this.resultsArray[i].key == key) {
                this.resultsArray.splice(i, 1);
                break;
              }
            }
            this.fire('key-exited', {
              key: key,
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            });
          }.bind(this));

          this.onKeyMovedRegistration = this.query.on("key_moved", function(key, location, distance) {
            this.resultsObject[key] = {
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            var data = {
              key: key,
              lat: location[0],
              lng: location[1],
              location: location,
              distance: distance
            };
            for (var i = 0; i < this.resultsArray.length; i++) {
              if (this.resultsArray[i].key == key) {
                this.resultsArray[i] = data;
                break;
              }
            }
            this.fire('key-moved', data);
          }.bind(this));

          this.onReadyRegistration = this.query.on("ready", function() {
            console.log('ready');
            this.fire('ready');
          }.bind(this));

        } else if (this.queryInstance) {
          this.queryInstance.cancel();
          this.queryInstance = null;
        }
      },

      _queryChanged: function(lat, lng, radius) {
        if ((this.lat || this.lat === 0) && (this.lng || this.lng === 0) && this.radius) {
          this.query.updateCriteria({
            center: [lat, lng],
            radius: radius
          });
        }
      }

      /**
       * Corresponds to the GeoQuery's `key_entered` event. Fires after updating the internal results.
       * @event key-entered
       * @param {key} string The location's identifier.
       * @param {lat} number Latitude.
       * @param {lng} number Longitude.
       * @param {location} array [lat, lng] shorthand.
       * @param {distance} number Distance from the query's center, in kilometers.
       */

      /**
       * Corresponds to the GeoQuery's `key_exited` event. Fires after updating the internal results.
       * @event key-exited
       * @param {key} string The location's identifier.
       * @param {lat} number Latitude.
       * @param {lng} number Longitude.
       * @param {location} array [lat, lng].
       * @param {distance} number Distance from the query's center, in kilometers.
       */

      /**
       * Corresponds to the GeoQuery's `key_moved` event. Fires after updating the internal results.
       * @event key-moved
       * @param {key} string The location's identifier.
       * @param {lat} number Latitude.
       * @param {lng} number Longitude.
       * @param {location} array [lat, lng].
       * @param {distance} number Distance from the query's center, in kilometers.
       */

      /**
       * Corresponds to the GeoQuery's `ready` event. Fired when the initial result set of the query is ready.
       * @event ready
       */
    });
  </script>
</dom-module>
