<link rel="import" href="geofire-elements-behavior.html">
<script>
    GeofireElementsQueryBehaviorImpl = {
        properties: {
            /**
             * The latitude for the query's center.
             */
            lat: Number,

            /**
             * The longitude for the query's center.
             */
            lng: Number,

            /**
             * The radius in kilometers around the query's center.
             */
            radius: Number,

            /**
             * Whether the query listens for any events.
             */
            enabled: {
                type: Boolean,
                observer: '_enabledChanged'
            },

            /**
             * An array managed by the GeoQuery [event types](https://github.com/firebase/geofire-js/blob/master/docs/reference.md#geoqueryoneventtype-callback).
             * Each element is an object with properties `key, lat, lng, location, distance`.
             */
            resultsArray: {
                type: Array,
                notify: true
            },

            /**
             * An object managed by the GeoQuery [event types](https://github.com/firebase/geofire-js/blob/master/docs/reference.md#geoqueryoneventtype-callback).
             * It is a map of key => {`lat, lng, location, distance`}.
             */
            resultsObject: {
                type: Object,
                notify: true
            }
        },

        observers: [
          '_queryChanged(lat, lng, radius)'
        ],

        /**
         * The [GeoQuery](https://github.com/firebase/geofire-js/blob/master/docs/reference.md#geoquery) instance.
         */
        get query() {
            if (!this.queryInstance) {
                this.queryInstance = this.geofire.query({
                    center: [this.lat, this.lng],
                    radius: this.radius
                });
            }
            return this.queryInstance;
        },

        _enabledChanged: function(enabled) {
            if (enabled) {
                this.resultsArray = [];
                this.resultsObject = {};


                this.onKeyEnteredRegistration = this.query.on("key_entered", function(key, location, distance) {
                    this.resultsObject[key] = {
                        lat: location[0],
                        lng: location[1],
                        location: location,
                        distance: distance
                    };
                    var data = {
                        key: key,
                        lat: location[0],
                        lng: location[1],
                        location: location,
                        distance: distance
                    };
                    this.resultsArray.push(data);
                    this.fire('key-entered', data);
                }.bind(this));

                this.onKeyExitedRegistration = this.query.on("key_exited", function(key, location, distance) {
                    this.resultsObject[key] = null;
                    for (var i = 0; i < this.resultsArray.length; i++) {
                        if (this.resultsArray[i].key == key) {
                            this.resultsArray.splice(i, 1);
                            break;
                        }
                    }
                    this.fire('key-exited', {
                        key: key,
                        lat: location[0],
                        lng: location[1],
                        location: location,
                        distance: distance
                    });
                }.bind(this));

                this.onKeyMovedRegistration = this.query.on("key_moved", function(key, location, distance) {
                    this.resultsObject[key] = {
                        lat: location[0],
                        lng: location[1],
                        location: location,
                        distance: distance
                    };
                    var data = {
                        key: key,
                        lat: location[0],
                        lng: location[1],
                        location: location,
                        distance: distance
                    };
                    for (var i = 0; i < this.resultsArray.length; i++) {
                        if (this.resultsArray[i].key == key) {
                            this.resultsArray[i] = data;
                            break;
                        }
                    }
                    this.fire('key-moved', data);
                }.bind(this));

                this.onReadyRegistration = this.query.on("ready", function() {
                    console.log('ready');
                    this.fire('ready');
                }.bind(this));

            } else if (this.queryInstance) {
                this.queryInstance.cancel();
                this.queryInstance = null;
            }
        },

        _queryChanged: function(lat, lng, radius) {
            this.query.updateCriteria({
                center: [lat, lng],
                radius: radius
            });
        }
    };

    GeofireElementsQueryBehavior = [GeofireElementsBehavior, GeofireElementsQueryBehaviorImpl];
</script>